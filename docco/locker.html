<!DOCTYPE html>

<html>
<head>
  <title>locker.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="balancer.html">
                  balancer.js
                </a>


                <a class="source" href="checksum.html">
                  checksum.js
                </a>


                <a class="source" href="cursor.html">
                  cursor.js
                </a>


                <a class="source" href="descent.html">
                  descent.js
                </a>


                <a class="source" href="extend.html">
                  extend.js
                </a>


                <a class="source" href="json.html">
                  json.js
                </a>


                <a class="source" href="locker.html">
                  locker.js
                </a>


                <a class="source" href="logger.html">
                  logger.js
                </a>


                <a class="source" href="page.html">
                  page.js
                </a>


                <a class="source" href="player.html">
                  player.js
                </a>


                <a class="source" href="queue.html">
                  queue.js
                </a>


                <a class="source" href="scram.html">
                  scram.js
                </a>


                <a class="source" href="scribe.html">
                  scribe.js
                </a>


                <a class="source" href="script.html">
                  script.js
                </a>


                <a class="source" href="sheaf.html">
                  sheaf.js
                </a>


                <a class="source" href="strata.html">
                  strata.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>locker.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> ok = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>).ok

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Locker</span> (<span class="hljs-params">sheaf, magazine</span>) </span>{
    ok(<span class="hljs-built_in">arguments</span>.length, <span class="hljs-string">'no arguments'</span>)
    ok(magazine)
    <span class="hljs-keyword">this</span>._locks = {}
    <span class="hljs-keyword">this</span>._sheaf = sheaf
    <span class="hljs-keyword">this</span>._magazine = magazine
}

Locker.prototype.lock = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, address, exclusive</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO locks does not appear to need to be an array.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> cartridge = <span class="hljs-keyword">this</span>._magazine.hold(address, {}),
        page = cartridge.value.page, locks = []

    ok(address != <span class="hljs-literal">null</span>, <span class="hljs-string">'x'</span> + address)
    ok(!<span class="hljs-keyword">this</span>._locks[address], <span class="hljs-string">'address already locked by this locker'</span>)

    <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (page == <span class="hljs-literal">null</span>) {
</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Note: This catch block is only good for catching read errors.
It untestable to catch errors in the first step that locks
the page, which is all tested, synchronous code. Instead of
throwing the error, we give it to the lock. The primary lock
sub-cadence will receive the error and raise it to be caugh
by the final external catch block.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO does there need to be differnt types anymore?</p>

            </div>

            <div class="content"><div class='highlight'><pre>                        page = <span class="hljs-keyword">this</span>._sheaf.createPage(address % <span class="hljs-number">2</span>, address)
                        cartridge.value.page = page
                        page.cartridge = cartridge
                        locks.push(<span class="hljs-keyword">this</span>._locks[address] = page.queue.createLock())
                        locks[<span class="hljs-number">0</span>].exclude(<span class="hljs-keyword">async</span>())
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        <span class="hljs-keyword">this</span>._sheaf.player.read(<span class="hljs-keyword">this</span>._sheaf, page, <span class="hljs-keyword">async</span>())
                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        locks[<span class="hljs-number">0</span>].unlock()
                    })
                }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                    cartridge.value.page = <span class="hljs-literal">null</span>
                    cartridge.adjustHeft(-cartridge.heft)
                    locks[<span class="hljs-number">0</span>].unlock(error)
                }])
            } <span class="hljs-keyword">else</span> {
                locks.push(<span class="hljs-keyword">this</span>._locks[address] = page.queue.createLock())
            }
            <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">this</span>._locks[page.address][exclusive ? <span class="hljs-string">'exclude'</span> : <span class="hljs-string">'share'</span>](<span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">this</span>._sheaf.tracer(<span class="hljs-string">'lock'</span>, { address: address, exclusive: exclusive }, <span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> [ page ]
            })
        }) <span class="hljs-comment">// TODO unecessary cadence</span>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
        cartridge.release()
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._locks[page.address]
        locks.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">lock</span>) </span>{
            lock.unlock(error)
        })
        <span class="hljs-keyword">throw</span> error
    }])
})

Locker.prototype.encache = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">page</span>) </span>{
    page.cartridge = <span class="hljs-keyword">this</span>._magazine.hold(page.address, { page: page })
    <span class="hljs-keyword">this</span>._locks[page.address] = page.queue.createLock()
    <span class="hljs-keyword">this</span>._locks[page.address].exclude(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{})
    <span class="hljs-keyword">return</span> page
}

Locker.prototype.checkCacheSize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">page</span>) </span>{
    <span class="hljs-keyword">var</span> heft = page.items.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">heft, item</span>) </span>{ <span class="hljs-keyword">return</span> heft + item.heft }, <span class="hljs-number">0</span>)
    ok(heft == page.cartridge.heft, <span class="hljs-string">'sizes are wrong'</span>)
}

Locker.prototype.unlock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">page</span>) </span>{
    <span class="hljs-keyword">this</span>.checkCacheSize(page)
    <span class="hljs-keyword">this</span>._locks[page.address].unlock(<span class="hljs-literal">null</span>, page)
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._locks[page.address].count) {
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._locks[page.address]
    }
    page.cartridge.release()
}

Locker.prototype.increment = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">page</span>) </span>{
    <span class="hljs-keyword">this</span>._locks[page.address].increment()
    <span class="hljs-keyword">this</span>._magazine.hold(page.address)
}

Locker.prototype.dispose = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    ok(!<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>._locks).length, <span class="hljs-string">'locks outstanding'</span>)
    <span class="hljs-keyword">this</span>._locks = <span class="hljs-literal">null</span>
}

<span class="hljs-built_in">module</span>.exports = Locker

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
