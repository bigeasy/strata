<!DOCTYPE html>

<html>
<head>
  <title>cursor.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="balancer.js.html">
                  balancer.js
                </a>


                <a class="source" href="checksum.js.html">
                  checksum.js
                </a>


                <a class="source" href="cursor.js.html">
                  cursor.js
                </a>


                <a class="source" href="descent.js.html">
                  descent.js
                </a>


                <a class="source" href="extend.js.html">
                  extend.js
                </a>


                <a class="source" href="json.js.html">
                  json.js
                </a>


                <a class="source" href="locker.js.html">
                  locker.js
                </a>


                <a class="source" href="logger.js.html">
                  logger.js
                </a>


                <a class="source" href="page.js.html">
                  page.js
                </a>


                <a class="source" href="player.js.html">
                  player.js
                </a>


                <a class="source" href="queue.js.html">
                  queue.js
                </a>


                <a class="source" href="scram.js.html">
                  scram.js
                </a>


                <a class="source" href="scribe.js.html">
                  scribe.js
                </a>


                <a class="source" href="script.js.html">
                  script.js
                </a>


                <a class="source" href="sheaf.js.html">
                  sheaf.js
                </a>


                <a class="source" href="strata.js.html">
                  strata.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>cursor.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> ok = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>).ok
<span class="hljs-keyword">var</span> Queue = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./queue'</span>)
<span class="hljs-keyword">var</span> Scribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./scribe'</span>)
<span class="hljs-keyword">var</span> scram = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./scram'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cursor</span> (<span class="hljs-params">sheaf, logger, descents, exclusive, searchKey</span>) </span>{
    <span class="hljs-keyword">this</span>.sheaf = sheaf
    <span class="hljs-keyword">this</span>.logger = logger
    <span class="hljs-keyword">this</span>._locker = descents[<span class="hljs-number">0</span>].locker
    <span class="hljs-keyword">this</span>.page = descents[<span class="hljs-number">0</span>].page
    <span class="hljs-keyword">this</span>.searchKey = searchKey
    <span class="hljs-keyword">this</span>.exclusive = exclusive
    <span class="hljs-keyword">this</span>.index = descents[<span class="hljs-number">0</span>].index
    <span class="hljs-keyword">this</span>.offset = <span class="hljs-keyword">this</span>.index &lt; <span class="hljs-number">0</span> ? ~<span class="hljs-keyword">this</span>.index : <span class="hljs-keyword">this</span>.index
    descents.shift()
}

Cursor.prototype.next = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> next

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.page.right.address === <span class="hljs-literal">null</span>) {</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>return [ async, false ] &lt;- return immediately!</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> [ <span class="hljs-literal">false</span> ]
    }

    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._locker.lock(<span class="hljs-keyword">this</span>.page.right.address, <span class="hljs-keyword">this</span>.exclusive, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) </span>{
        <span class="hljs-keyword">this</span>._locker.unlock(<span class="hljs-keyword">this</span>.page)

        <span class="hljs-keyword">this</span>.page = next

        <span class="hljs-keyword">this</span>.offset = <span class="hljs-keyword">this</span>.page.ghosts
        <span class="hljs-keyword">this</span>.length = <span class="hljs-keyword">this</span>.page.items.length

        <span class="hljs-keyword">return</span> [ <span class="hljs-literal">true</span> ]
    })
})

Cursor.prototype.indexOf = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, index</span>) </span>{
    ok(<span class="hljs-built_in">arguments</span>.length == <span class="hljs-number">2</span>, <span class="hljs-string">'index requires two arguments'</span>)
    <span class="hljs-keyword">var</span> page = <span class="hljs-keyword">this</span>.page
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.sheaf.find(page, key, index)
    <span class="hljs-keyword">var</span> unambiguous
    unambiguous = <span class="hljs-number">-1</span> &lt; index <span class="hljs-comment">// &lt;- TODO ?</span>
               || ~ index &lt; <span class="hljs-keyword">this</span>.page.items.length
               || page.right.address === <span class="hljs-literal">null</span>
    <span class="hljs-keyword">if</span> (!unambiguous &amp;&amp; <span class="hljs-keyword">this</span>.sheaf.comparator(key, page.right.key) &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> [ ~(<span class="hljs-keyword">this</span>.page.items.length + <span class="hljs-number">1</span>) ]
    }
    <span class="hljs-keyword">return</span> index
}

Cursor.prototype._unlock = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._locker.unlock(<span class="hljs-keyword">this</span>.page)
        <span class="hljs-keyword">this</span>._locker.dispose()
    }], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._appender.close(<span class="hljs-keyword">async</span>())
    })
})</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO pass an integer as the first argument to force the arity of the
return.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Cursor.prototype.unlock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._appender) {
        <span class="hljs-keyword">this</span>._unlock(callback)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._locker.unlock(<span class="hljs-keyword">this</span>.page)
        <span class="hljs-keyword">this</span>._locker.dispose()
        callback()
    }
}

Cursor.prototype.insert = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">record, key, index</span>) </span>{
    ok(<span class="hljs-keyword">this</span>.exclusive, <span class="hljs-string">'cursor is not exclusive'</span>)
    ok(index &gt; <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span>.page.address == <span class="hljs-number">1</span>)

    <span class="hljs-keyword">this</span>.sheaf.unbalanced(<span class="hljs-keyword">this</span>.page)

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._appender == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>._appender = <span class="hljs-keyword">this</span>.logger.createAppender(<span class="hljs-keyword">this</span>.page)
    }

    <span class="hljs-keyword">var</span> heft = <span class="hljs-keyword">this</span>._appender.writeInsert(index, record).length
    <span class="hljs-keyword">this</span>.page.splice(index, <span class="hljs-number">0</span>, {
        <span class="hljs-attr">key</span>: key,
        <span class="hljs-attr">record</span>: record,
        <span class="hljs-attr">heft</span>: heft
    })

    <span class="hljs-keyword">this</span>.length = <span class="hljs-keyword">this</span>.page.items.length
}

Cursor.prototype.remove = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">index</span>) </span>{
    <span class="hljs-keyword">var</span> ghost = <span class="hljs-keyword">this</span>.page.address != <span class="hljs-number">1</span> &amp;&amp; index == <span class="hljs-number">0</span>, entry
    <span class="hljs-keyword">this</span>.sheaf.unbalanced(<span class="hljs-keyword">this</span>.page)

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._appender == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>._appender = <span class="hljs-keyword">this</span>.logger.createAppender(<span class="hljs-keyword">this</span>.page)
    }

    <span class="hljs-keyword">this</span>._appender.writeDelete(index)

    <span class="hljs-keyword">if</span> (ghost) {
        <span class="hljs-keyword">this</span>.page.ghosts++
        <span class="hljs-keyword">this</span>.offset || <span class="hljs-keyword">this</span>.offset++
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.page.splice(index, <span class="hljs-number">1</span>)
    }
}

<span class="hljs-built_in">module</span>.exports = Cursor</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
